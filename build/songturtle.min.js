/*! songturtle 2019-10-09 */

function formatTime(t){return`${Math.floor(t/60)}:${padSeconds(Math.floor(t%60))}`}function padSeconds(t){return t<10?`0${t}`:t}function showElement(t,i){i=i||"block","string"==typeof t&&(t=document.getElementById(t)),t.setAttribute("style",`display:${i}`)}function hideElement(t){"string"==typeof t&&(t=document.getElementById(t)),t.setAttribute("style","display:none")}function Waveform(t,i){this.audioBuffer=t,this.length=i,this.maxData=0,this.rms=function(){this.maxData=-1/0;const t=this.audioBuffer.length,i=Math.floor(t/this.length),e=this.audioBuffer.numberOfChannels,o=[];for(var n=0;n<e;n++)o.push(this.audioBuffer.getChannelData(n));const s=new Float32Array(this.length);for(var a=0,l=0;l<t;l+=i){for(var r=0,h=l;h<l+i;h++)for(n=0;n<e;n++)r+=o[n][h]*o[n][h];const t=Math.sqrt(r/(i*e));s[a++]=t,t>this.maxData&&(this.maxData=t)}return s},this.data=this.rms()}function Song(t,i){this.audioCtx=t,this.isPlaying=!1,this.audioBuffer=i,this.duration=this.audioBuffer.duration,this.intervalId=0,this.playback=1,this.timeStepMs=50,this.position=0,this.waveformLength=200,this.waveform=new Waveform(this.audioBuffer,this.waveformLength),this.looping=!1,this.loopStart=0,this.loopEnd=0,this.startTime=0,this.play=function(t){this.isPlaying||(this._play(t),this.onStartCallback&&this.onStartCallback())},this._play=function(t){void 0===t||null===t?t=this.position:this.position=t,this._createBufferSource(),this.source.start(0,t),this.startTime=this.getCurrentTime(),this.isPlaying=!0,this.lastTimeStep=this.startTime,1!=this.playback?this.intervalId=setTimeout(this.timeStep.bind(this),this.timeStepMs):this.intervalId=setInterval(this.timeStep.bind(this),this.timeStepMs)},this._createBufferSource=function(){this.source=this.audioCtx.createBufferSource(),this.source.buffer=this.audioBuffer,this.looping&&(this.source.loop=!0,this.source.loopStart=this.loopStart,this.source.loopEnd=this.loopEnd),this.source.connect(this.audioCtx.destination)},this.seek=function(t){t<0&&(t=0),this.looping&&(t>this.loopEnd?t=this.loopStart+(t-this.loopEnd):t<this.loopStart&&(t=this.loopStart)),t>this.duration&&(t=this.duration),this.position=t,this.isPlaying&&(this._stop(),this._play())},this.stop=function(){this.isPlaying&&(this._stop(),this.onStopCallback&&this.onStopCallback())},this._stop=function(){clearInterval(this.intervalId),this.position+=this.getDelta()*this.playback,this.source.stop(),this.isPlaying=!1},this.reset=function(){this.position=0,this.unloop()},this.loop=function(t,i){this.looping=!0,this.loopStart=t,this.loopEnd=i},this.unloop=function(){this.looping=!1,this.loopStart=0,this.loopEnd=0,this.isPlaying&&(this._stop(),this._play())},this.lastTimeStep=0,this.timeStep=function(){if(this.isPlaying){if(this.position+=this.getDelta()*this.playback,this.position>this.duration)return this.stop(),void this.reset();if(this.looping){const t=this.loopStart,i=this.loopEnd;this.position>=i&&(this.position=t+(this.position-i))}this.lastTimeStep=this.getCurrentTime(),1!=this.playback&&(this._stop(),this._play())}},this.getDelta=function(){return this.getCurrentTime()-this.lastTimeStep},this.getCurrentTime=function(){return this.audioCtx.currentTime},this.onStartCallback=null,this.onStart=function(t){this.onStartCallback=t},this.onStopCallback=null,this.onStop=function(t){this.onStopCallback=t},this.changePlayback=function(t){this.playback=t,this.isPlaying&&(this.stop(),this.play())}}function Renderer(t,i){this.waveformColor="#000000",this.waveformProgressColor="#ef8a17",this.waveformSelectedColor="#ef2917",this.loopColor="#008148",this.loopProgressColor="#c6c013",this.canvas=t,this.ctx=t.getContext("2d"),this.song=i,this.waveform=i.waveform,this.padding=1,this.scale=(this.canvas.height/2-1)/this.waveform.maxData,this.barWidth=this.canvas.width/this.waveform.length-this.padding,this.selectionBar=null,this.loopStart=null,this.loopEnd=null,this.selectionStart=null,this.selectionEnd=null,this.drawWaveform=function(t){if(null==(t=t||this).canvas||null==t.song||null==t.waveform)return void console.log("canvas, song, or waveform was null; doing nothing.");const i=t.song.position;t.ctx.clearRect(0,0,t.canvas.width,t.canvas.height),t.ctx.fillStyle="#ffffff",t.ctx.fillRect(0,0,t.canvas.width,t.canvas.height);const e=Math.ceil(t.waveform.length/t.waveform.audioBuffer.duration*i);if(t.song.looping){if(null!==t.loopStart&&null!==t.loopEnd&&(t._drawBars(t.waveformColor,0,t.loopStart),t._drawBars(t.loopProgressColor,t.loopStart,e),t._drawBars(t.loopColor,e,t.loopEnd),t._drawBars(t.waveformColor,t.loopEnd)),null!==t.selectionStart&&null!==t.selectionEnd){const i=Math.min(t.selectionStart,t.selectionEnd),e=Math.max(t.selectionStart,t.selectionEnd);t._drawBars(t.loopColor,i,e+1)}}else{if(null!==t.selectionBar){const i=Math.min(t.selectionBar,e),o=i===t.selectionBar?e:t.selectionBar;t._drawBars(t.waveformProgressColor,0,i),t._drawBars(t.waveformSelectedColor,i,o),t._drawBars(t.waveformColor,o)}else t._drawBars(t.waveformProgressColor,0,e),t._drawBars(t.waveformColor,e);if(null!==t.selectionStart&&null!==t.selectionEnd){const i=Math.min(t.selectionStart,t.selectionEnd),e=Math.max(t.selectionStart,t.selectionEnd);t._drawBars(t.loopColor,i,e+1)}}},this._drawBars=function(t,i,e){void 0!==e&&null!==e||(e=this.waveform.length),this.ctx.fillStyle=t;for(var o=i;o<e;o++)this._drawBar(this.ctx,o*this.barWidth+o*this.padding,this.canvas.height/2,this.barWidth,this.scale*this.waveform.data[o])},this._drawBar=function(t,i,e,o,n){t.fillRect(i+this.padding,e,o,n),t.fillRect(i+this.padding,e,o,-n)}}!function(){const t=new(window.AudioContext||window.webkitAudioContext),i=document.querySelector("canvas");document.getElementById("playback-div");var e=null,o=null,n=null,s=null;function a(i){t.decodeAudioData(i.target.result,l,r)}function l(n){hideElement("loadingDiv"),showElement("musicDiv"),showElement("playbackDiv"),showElement("accordion"),(e=new Song(t,n,i)).onStart(u),e.onStop(u),(o=new Renderer(i,e)).drawWaveform(),document.getElementById("timeSpan").innerHTML=`0:00/${formatTime(e.duration)}`}function r(t){hideElement("loadingDiv");const i=document.getElementById("errorDiv");showElement(i),i.innerHTML="Error decoding song",console.log("error decoding song")}document.getElementById("fileInput").addEventListener("change",function(){const t=this.files;if(0===t.length)return;hideElement("errorDiv"),e&&(e.stop(),e=null);const i=t[0],o=new FileReader;showElement("loadingDiv"),o.addEventListener("load",a),o.readAsArrayBuffer(i),document.getElementById("songName").innerHTML=`<strong>${i.name}</strong>`});const h=document.getElementById("playButton");function c(){null!=e&&(e.isPlaying?(e.stop(),-1!==C&&(clearInterval(C),C=-1,v(B,e.position))):e.play())}function u(){e&&(e.isPlaying?(h.innerHTML='<i class="fas fa-pause-circle"></i>',n=setInterval(o.drawWaveform,40,o),s=setInterval(f,200,e)):(h.innerHTML='<i class="fas fa-play-circle"></i>',clearInterval(n),clearInterval(s)))}h.addEventListener("click",c);var d=null;function f(t){var i=d;null===i&&(i=t.position),i=formatTime(i),document.getElementById("timeSpan").innerHTML=i+"/"+formatTime(t.duration)}i.addEventListener("mousemove",function(t){if(e){var i=E(t);e.isPlaying&&null!==o&&(o.selectionBar=i,d=y(o.selectionBar),f(e)),m&&Date.now()-p>300&&(o.selectionBar=null,o.selectionStart=g,o.selectionEnd=i,e.isPlaying||o.drawWaveform(o))}}),i.addEventListener("mouseleave",function(t){e&&(o&&(o.selectionBar=null),d=null,f(e))});var p=null,m=!1,g=null;function v(t,i){o.selectionStart=null,o.selectionEnd=null,o.loopStart=S(t),o.loopEnd=S(i),e.stop(),e.loop(t,i),e.play(e.loopStart),document.getElementById("loopStart").innerHTML=formatTime(t),document.getElementById("loopEnd").innerHTML=formatTime(i),showElement("loopDiv")}function w(){e&&e.looping&&(e.unloop(),o.loopStart=null,o.loopEnd=null,hideElement("loopDiv"))}function y(t){return t*(e.duration/e.waveform.length)}function S(t){return Math.floor(t*(e.waveform.length/e.duration))}function E(t){return Math.floor(function(t,i,e){const o=e.getClientRects()[0];return t-=o.x,i-=o.y,{x:t*(e.width/o.width),y:i*(e.height/o.height)}}(t.clientX,t.clientY,i).x*(e.waveform.length/i.width))}i.addEventListener("mousedown",function(t){e&&(m=!0,p=Date.now(),g=E(t))}),i.addEventListener("mouseup",function(t){if(e)if(m=!1,Date.now()-p<=300){if(!e.isPlaying)return void e.play();var i=y(E(t));e.looping&&(i<e.loopStart||i>e.loopEnd)&&w(),e.seek(i),f(e)}else{const t=Math.min(o.selectionStart,o.selectionEnd),i=Math.max(o.selectionStart,o.selectionEnd);v(y(t),y(i))}});var B,b,C=-1;function k(t){o.selectionEnd=S(t.position),b=t.position}document.querySelector("body").onkeydown=function(t){if(e)switch(t.key){case" ":t.preventDefault(),c();break;case"Backspace":t.preventDefault(),w(),o&&o.drawWaveform(o);break;case"ArrowLeft":t.preventDefault(),e.seek(e.position-5);break;case"ArrowRight":t.preventDefault(),e.seek(e.position+5);break;case"ArrowUp":if(t.preventDefault(),T>0){_({target:D.item(T-1)})}break;case"ArrowDown":if(t.preventDefault(),T<D.length-1){_({target:D.item(T+1)})}break;case"l":e.isPlaying&&!e.looping&&(-1===C?(B=e.position,o.selectionStart=S(e.position),C=setInterval(k,20,e)):-1!==C&&(b=e.position,clearInterval(C),C=-1,v(B,b)))}};const D=document.getElementsByClassName("playbackButton");let T=3;function _(t){if(!e)return;if(T>-1&&T<D.length){let t=D.item(T);t.classList.remove("btn-warning"),t.classList.add("btn-success")}let i=t.target;i.classList.remove("btn-success"),i.classList.add("btn-warning"),e.changePlayback(i.value);for(let t=0;t<D.length;t++){D.item(t).classList.contains("btn-warning")&&(T=t)}}for(let t=0;t<D.length;t++)D.item(t).addEventListener("click",_)}();