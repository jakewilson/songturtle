/*! songturtle 2019-10-10 */

function formatTime(t){return`${Math.floor(t/60)}:${padSeconds(Math.floor(t%60))}`}function padSeconds(t){return t<10?`0${t}`:t}function showElement(t,e){e=e||"block","string"==typeof t&&(t=document.getElementById(t)),t.setAttribute("style",`display:${e}`)}function hideElement(t){"string"==typeof t&&(t=document.getElementById(t)),t.setAttribute("style","display:none")}function Waveform(t,e){this.audioBuffer=t,this.length=e,this.maxData=0,this.rms=function(){this.maxData=-1/0;const t=this.audioBuffer.length,e=Math.floor(t/this.length),i=this.audioBuffer.numberOfChannels,o=[];for(var n=0;n<i;n++)o.push(this.audioBuffer.getChannelData(n));const s=new Float32Array(this.length);for(var a=0,l=0;l<t;l+=e){for(var r=0,h=l;h<l+e;h++)for(n=0;n<i;n++)r+=o[n][h]*o[n][h];const t=Math.sqrt(r/(e*i));s[a++]=t,t>this.maxData&&(this.maxData=t)}return s},this.data=this.rms()}function Song(t,e){this.audioCtx=t,this.isPlaying=!1,this.audioBuffer=e,this.duration=this.audioBuffer.duration,this.intervalId=0,this.playback=1,this.timeStepMs=50,this.position=0,this.waveformLength=200,this.waveform=new Waveform(this.audioBuffer,this.waveformLength),this.looping=!1,this.loopStart=0,this.loopEnd=0,this.startTime=0,this.play=function(t){this.isPlaying||(this._play(t),this.onStartCallback&&this.onStartCallback())},this._play=function(t){void 0===t||null===t?t=this.position:this.position=t,this._createBufferSource(),this.source.start(0,t),this.startTime=this.getCurrentTime(),this.isPlaying=!0,this.lastTimeStep=this.startTime,1!=this.playback?this.intervalId=setTimeout(this.timeStep.bind(this),this.timeStepMs):this.intervalId=setInterval(this.timeStep.bind(this),this.timeStepMs)},this._createBufferSource=function(){this.source=this.audioCtx.createBufferSource(),this.source.buffer=this.audioBuffer,this.looping&&(this.source.loop=!0,this.source.loopStart=this.loopStart,this.source.loopEnd=this.loopEnd),this.source.connect(this.audioCtx.destination)},this.seek=function(t){t<0&&(t=0),this.looping&&(t>this.loopEnd?t=this.loopStart+(t-this.loopEnd):t<this.loopStart&&(t=this.loopStart)),t>this.duration&&(t=this.duration),this.position=t,this.isPlaying&&(this._stop(),this._play())},this.stop=function(){this.isPlaying&&(this._stop(),this.onStopCallback&&this.onStopCallback())},this._stop=function(){clearInterval(this.intervalId),this.position+=this.getDelta()*this.playback,this.source.stop(),this.isPlaying=!1},this.reset=function(){this.position=0,this.unloop()},this.loop=function(t,e){this.looping=!0,this.loopStart=t,this.loopEnd=e},this.unloop=function(){this.looping=!1,this.loopStart=0,this.loopEnd=0,this.isPlaying&&(this._stop(),this._play())},this.lastTimeStep=0,this.timeStep=function(){if(this.isPlaying){if(this.position+=this.getDelta()*this.playback,this.position>this.duration)return this.stop(),void this.reset();if(this.looping){const t=this.loopStart,e=this.loopEnd;this.position>=e&&(this.position=t+(this.position-e))}this.lastTimeStep=this.getCurrentTime(),1!=this.playback&&(this._stop(),this._play())}},this.getDelta=function(){return this.getCurrentTime()-this.lastTimeStep},this.getCurrentTime=function(){return this.audioCtx.currentTime},this.onStartCallback=null,this.onStart=function(t){this.onStartCallback=t},this.onStopCallback=null,this.onStop=function(t){this.onStopCallback=t},this.changePlayback=function(t){this.playback=t,this.isPlaying&&(this.stop(),this.play())}}function Renderer(t,e){this.waveformColor="#000000",this.waveformProgressColor="#ef8a17",this.waveformSelectedColor="#ef2917",this.loopColor="#008148",this.loopProgressColor="#c6c013",this.canvas=t,this.ctx=t.getContext("2d"),this.song=e,this.waveform=e.waveform,this.padding=1,this.scale=(this.canvas.height/2-1)/this.waveform.maxData,this.barWidth=this.canvas.width/this.waveform.length-this.padding,this.selectionBar=null,this.loopStart=null,this.loopEnd=null,this.selectionStart=null,this.selectionEnd=null,this.drawWaveform=function(t){if(null==(t=t||this).canvas||null==t.song||null==t.waveform)return void console.log("canvas, song, or waveform was null; doing nothing.");const e=t.song.position;t.ctx.clearRect(0,0,t.canvas.width,t.canvas.height),t.ctx.fillStyle="#ffffff",t.ctx.fillRect(0,0,t.canvas.width,t.canvas.height);const i=Math.ceil(t.waveform.length/t.waveform.audioBuffer.duration*e);if(t.song.looping){if(null!==t.loopStart&&null!==t.loopEnd&&(t._drawBars(t.waveformColor,0,t.loopStart),t._drawBars(t.loopProgressColor,t.loopStart,i),t._drawBars(t.loopColor,i,t.loopEnd),t._drawBars(t.waveformColor,t.loopEnd)),null!==t.selectionStart&&null!==t.selectionEnd){const e=Math.min(t.selectionStart,t.selectionEnd),i=Math.max(t.selectionStart,t.selectionEnd);t._drawBars(t.loopColor,e,i+1)}}else{if(null!==t.selectionBar){const e=Math.min(t.selectionBar,i),o=e===t.selectionBar?i:t.selectionBar;t._drawBars(t.waveformProgressColor,0,e),t._drawBars(t.waveformSelectedColor,e,o),t._drawBars(t.waveformColor,o)}else t._drawBars(t.waveformProgressColor,0,i),t._drawBars(t.waveformColor,i);if(null!==t.selectionStart&&null!==t.selectionEnd){const e=Math.min(t.selectionStart,t.selectionEnd),i=Math.max(t.selectionStart,t.selectionEnd);t._drawBars(t.loopColor,e,i+1)}}},this._drawBars=function(t,e,i){void 0!==i&&null!==i||(i=this.waveform.length),this.ctx.fillStyle=t;for(var o=e;o<i;o++)this._drawBar(this.ctx,o*this.barWidth+o*this.padding,this.canvas.height/2,this.barWidth,this.scale*this.waveform.data[o])},this._drawBar=function(t,e,i,o,n){t.fillRect(e+this.padding,i,o,n),t.fillRect(e+this.padding,i,o,-n)}}!function(){const t=new(window.AudioContext||window.webkitAudioContext),e=document.querySelector("canvas");document.getElementById("playback-div");var i=null,o=null,n=null,s=null,a="";function l(e){t.decodeAudioData(e,r,h)}function r(n){hideElement("loadingDiv"),showElement("musicDiv"),showElement("playbackDiv"),showElement("accordion"),(i=new Song(t,n,e)).onStart(d),i.onStop(d),(o=new Renderer(e,i)).drawWaveform(),document.getElementById("timeSpan").innerHTML=`0:00/${formatTime(i.duration)}`,document.getElementById("songName").innerHTML=`<strong>${a}</strong>`}function h(t){hideElement("loadingDiv");const e=document.getElementById("errorDiv");showElement(e),e.innerHTML="Error decoding song",console.log("error decoding song")}document.getElementById("fileInput").addEventListener("change",function(){const t=this.files;if(0===t.length)return;hideElement("errorDiv"),i&&(i.stop(),i=null);const e=t[0],o=new FileReader;showElement("loadingDiv"),o.addEventListener("load",t=>{l(t.target.result)}),o.readAsArrayBuffer(e),a=e.name});const c=document.getElementById("playButton");function u(){i&&(i.isPlaying?(i.stop(),-1!==k&&(clearInterval(k),k=-1,w(b,i.position))):i.play())}function d(){i&&(i.isPlaying?(c.innerHTML='<i class="fas fa-pause-circle"></i>',n=setInterval(o.drawWaveform,40,o),s=setInterval(p,200,i)):(c.innerHTML='<i class="fas fa-play-circle"></i>',clearInterval(n),clearInterval(s)))}c.addEventListener("click",u);var f=null;function p(t){var e=f;null===e&&(e=t.position),e=formatTime(e),document.getElementById("timeSpan").innerHTML=e+"/"+formatTime(t.duration)}e.addEventListener("mousemove",function(t){if(i){var e=B(t);i.isPlaying&&null!==o&&(o.selectionBar=e,f=S(o.selectionBar),p(i)),g&&Date.now()-m>300&&(o.selectionBar=null,o.selectionStart=v,o.selectionEnd=e,i.isPlaying||o.drawWaveform(o))}}),e.addEventListener("mouseleave",function(t){i&&(o&&(o.selectionBar=null),f=null,p(i))});var m=null,g=!1,v=null;function w(t,e){o.selectionStart=null,o.selectionEnd=null,o.loopStart=E(t),o.loopEnd=E(e),i.stop(),i.loop(t,e),i.play(i.loopStart),document.getElementById("loopStart").innerHTML=formatTime(t),document.getElementById("loopEnd").innerHTML=formatTime(e),showElement("loopDiv")}function y(){i&&i.looping&&(i.unloop(),o.loopStart=null,o.loopEnd=null,hideElement("loopDiv"))}function S(t){return t*(i.duration/i.waveform.length)}function E(t){return Math.floor(t*(i.waveform.length/i.duration))}function B(t){return Math.floor(function(t,e,i){const o=i.getClientRects()[0];return t-=o.x,e-=o.y,{x:t*(i.width/o.width),y:e*(i.height/o.height)}}(t.clientX,t.clientY,e).x*(i.waveform.length/e.width))}e.addEventListener("mousedown",function(t){i&&(g=!0,m=Date.now(),v=B(t))}),e.addEventListener("mouseup",function(t){if(i)if(g=!1,Date.now()-m<=300){if(!i.isPlaying)return void i.play();var e=S(B(t));i.looping&&(e<i.loopStart||e>i.loopEnd)&&y(),i.seek(e),p(i)}else{const t=Math.min(o.selectionStart,o.selectionEnd),e=Math.max(o.selectionStart,o.selectionEnd);w(S(t),S(e))}});var b,C,k=-1;function D(t){o.selectionEnd=E(t.position),C=t.position}document.querySelector("body").onkeydown=function(t){if(i)switch(t.key){case" ":t.preventDefault(),u();break;case"Backspace":t.preventDefault(),y(),o&&o.drawWaveform(o);break;case"ArrowLeft":t.preventDefault(),i.seek(i.position-5);break;case"ArrowRight":t.preventDefault(),i.seek(i.position+5);break;case"ArrowUp":if(t.preventDefault(),M>0){_({target:T.item(M-1)})}break;case"ArrowDown":if(t.preventDefault(),M<T.length-1){_({target:T.item(M+1)})}break;case"l":i.isPlaying&&!i.looping&&(-1===k?(b=i.position,o.selectionStart=E(i.position),k=setInterval(D,20,i)):-1!==k&&(C=i.position,clearInterval(k),k=-1,w(b,C)))}};const T=document.getElementsByClassName("playbackButton");let M=3;function _(t){if(!i)return;if(M>-1&&M<T.length){let t=T.item(M);t.classList.remove("btn-warning"),t.classList.add("btn-success")}let e=t.target;e.classList.remove("btn-success"),e.classList.add("btn-warning"),i.changePlayback(e.value);for(let t=0;t<T.length;t++){T.item(t).classList.contains("btn-warning")&&(M=t)}}for(let t=0;t<T.length;t++)T.item(t).addEventListener("click",_);!function(){const t=new XMLHttpRequest;t.open("GET","audio/songturtle.mp3",!0),a="songturtle.mp3",t.onload=function(){l(t.response)},t.responseType="arraybuffer",t.send()}()}();