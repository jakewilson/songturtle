/*! songturtle 2019-10-15 */

function formatTime(t){return`${Math.floor(t/60)}:${padSeconds(Math.floor(t%60))}`}function padSeconds(t){return t<10?`0${t}`:t}function showElement(t,i){i=i||"block","string"==typeof t&&(t=document.getElementById(t)),t.setAttribute("style",`display:${i}`)}function hideElement(t){"string"==typeof t&&(t=document.getElementById(t)),t.setAttribute("style","display:none")}function Waveform(t,i){this.audioBuffer=t,this.length=i,this.maxData=0,this.rms=function(){this.maxData=-1/0;const t=this.audioBuffer.length,i=Math.floor(t/this.length),e=this.audioBuffer.numberOfChannels,n=[];for(var o=0;o<e;o++)n.push(this.audioBuffer.getChannelData(o));const s=new Float32Array(this.length);for(var a=0,l=0;l<t;l+=i){for(var r=0,h=l;h<l+i;h++)for(o=0;o<e;o++)r+=n[o][h]*n[o][h];const t=Math.sqrt(r/(i*e));s[a++]=t,t>this.maxData&&(this.maxData=t)}return s},this.data=this.rms()}function Song(t,i){this.audioCtx=t,this.isPlaying=!1,this.audioBuffer=i,this.duration=this.audioBuffer.duration,this.intervalId=0,this.playback=1,this.timeStepMs=50,this.position=0,this.waveformLength=200,this.waveform=new Waveform(this.audioBuffer,this.waveformLength),this.looping=!1,this.loopStart=0,this.loopEnd=0,this.startTime=0,this.play=function(t){this.isPlaying||(this._play(t),this.onStartCallback&&this.onStartCallback())},this._play=function(t){void 0===t||null===t?t=this.position:this.position=t,this._createBufferSource(),this.source.start(0,t),this.startTime=this.getCurrentTime(),this.isPlaying=!0,this.lastTimeStep=this.startTime,1!=this.playback?this.intervalId=setTimeout(this.timeStep.bind(this),this.timeStepMs):this.intervalId=setInterval(this.timeStep.bind(this),this.timeStepMs)},this._createBufferSource=function(){this.source=this.audioCtx.createBufferSource(),this.source.buffer=this.audioBuffer,this.looping&&(this.source.loop=!0,this.source.loopStart=this.loopStart,this.source.loopEnd=this.loopEnd),this.source.connect(this.audioCtx.destination)},this.seek=function(t){t<0&&(t=0),this.looping&&(t>this.loopEnd?t=this.loopStart+(t-this.loopEnd):t<this.loopStart&&(t=this.loopStart)),t>this.duration&&(t=this.duration),this.position=t,this.isPlaying&&(this._stop(),this._play())},this.stop=function(){this.isPlaying&&(this._stop(),this.onStopCallback&&this.onStopCallback())},this._stop=function(){clearInterval(this.intervalId),this.position+=this.getDelta()*this.playback,this.source.stop(),this.isPlaying=!1},this.reset=function(){this.position=0,this.unloop()},this.loop=function(t,i){this.looping=!0,this.loopStart=t,this.loopEnd=i},this.unloop=function(){this.looping=!1,this.loopStart=0,this.loopEnd=0,this.isPlaying&&(this._stop(),this._play())},this.lastTimeStep=0,this.timeStep=function(){if(this.isPlaying){if(this.position+=this.getDelta()*this.playback,this.position>this.duration)return this.stop(),void this.reset();if(this.looping){const t=this.loopStart,i=this.loopEnd;this.position>=i&&(this.position=t+(this.position-i))}this.lastTimeStep=this.getCurrentTime(),1!=this.playback&&(this._stop(),this._play())}},this.getDelta=function(){return this.getCurrentTime()-this.lastTimeStep},this.getCurrentTime=function(){return this.audioCtx.currentTime},this.onStartCallback=null,this.onStart=function(t){this.onStartCallback=t},this.onStopCallback=null,this.onStop=function(t){this.onStopCallback=t},this.changePlayback=function(t){this.playback=t,this.isPlaying&&(this.stop(),this.play())}}function Renderer(t,i){this.waveformColor="#000000",this.waveformProgressColor="#ef8a17",this.waveformSelectedColor="#ef2917",this.loopColor="#008148",this.loopProgressColor="#c6c013",this.canvas=t,this.ctx=t.getContext("2d"),this.song=i,this.waveform=i.waveform,this.padding=1,this.scale=(this.canvas.height/2-1)/this.waveform.maxData,this.barWidth=this.canvas.width/this.waveform.length-this.padding,this.selectionBar=null,this.loopStart=null,this.loopEnd=null,this.selectionStart=null,this.selectionEnd=null,this.drawWaveform=function(){if(null==this.canvas||null==this.song||null==this.waveform)return void console.log("canvas, song, or waveform was null; doing nothing.");const t=this.song.position;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const i=Math.ceil(this.waveform.length/this.waveform.audioBuffer.duration*t);if(this.song.looping){if(null!==this.loopStart&&null!==this.loopEnd&&(this._drawBars(this.waveformColor,0,this.loopStart),this._drawBars(this.loopProgressColor,this.loopStart,i),this._drawBars(this.loopColor,i,this.loopEnd),this._drawBars(this.waveformColor,this.loopEnd)),null!==this.selectionStart&&null!==this.selectionEnd){const t=Math.min(this.selectionStart,this.selectionEnd),i=Math.max(this.selectionStart,this.selectionEnd);this._drawBars(this.loopColor,t,i+1)}}else{if(null!==this.selectionBar){const t=Math.min(this.selectionBar,i),e=t===this.selectionBar?i:this.selectionBar;this._drawBars(this.waveformProgressColor,0,t),this._drawBars(this.waveformSelectedColor,t,e),this._drawBars(this.waveformColor,e)}else this._drawBars(this.waveformProgressColor,0,i),this._drawBars(this.waveformColor,i);if(null!==this.selectionStart&&null!==this.selectionEnd){const t=Math.min(this.selectionStart,this.selectionEnd),i=Math.max(this.selectionStart,this.selectionEnd);this._drawBars(this.loopColor,t,i+1)}}window.requestAnimationFrame(this.drawWaveform.bind(this))},this._drawBars=function(t,i,e){void 0!==e&&null!==e||(e=this.waveform.length),this.ctx.fillStyle=t;for(var n=i;n<e;n++)this._drawBar(this.ctx,n*this.barWidth+n*this.padding,this.canvas.height/2,this.barWidth,this.scale*this.waveform.data[n])},this._drawBar=function(t,i,e,n,o){t.fillRect(i+this.padding,e,n,o),t.fillRect(i+this.padding,e,n,-o)}}!function(){const t=new(window.AudioContext||window.webkitAudioContext),i=document.querySelector("canvas");var e=null,n=null,o=null,s="";function a(i){t.decodeAudioData(i,l,r)}function l(o){hideElement("loadingDiv"),showElement("musicDiv"),(e=new Song(t,o,i)).onStart(u),e.onStop(u),(n=new Renderer(i,e)).drawWaveform(),document.getElementById("timeSpan").innerHTML=`0:00/${formatTime(e.duration)}`,document.getElementById("songName").innerHTML=`<strong>${s}</strong>`}function r(t){hideElement("loadingDiv");const i=document.getElementById("errorDiv");showElement(i),i.innerHTML="Error decoding song",console.log("error decoding song")}document.getElementById("fileInput").addEventListener("change",function(){const t=this.files;if(0===t.length)return;hideElement("errorDiv"),e&&(e.stop(),e=null);const i=t[0],n=new FileReader;showElement("loadingDiv"),n.addEventListener("load",t=>{a(t.target.result)}),n.readAsArrayBuffer(i),s=i.name});const h=document.getElementById("playButton");function c(){e&&(e.isPlaying?(e.stop(),-1!==C&&(clearInterval(C),C=-1,v(B,e.position))):e.play())}function u(){e&&(e.isPlaying?(h.innerHTML='<i class="fas fa-pause-circle"></i>',o=setInterval(f,200,e)):(h.innerHTML='<i class="fas fa-play-circle"></i>',clearInterval(o)))}h.addEventListener("click",c);var d=null;function f(t){var i=d;null===i&&(i=t.position),i=formatTime(i),document.getElementById("timeSpan").innerHTML=i+"/"+formatTime(t.duration)}i.addEventListener("mousemove",function(t){if(e){var i=E(t);null!==n&&(n.selectionBar=i,d=y(n.selectionBar),f(e)),m&&Date.now()-p>300&&(n.selectionBar=null,n.selectionStart=g,n.selectionEnd=i,e.isPlaying||n.drawWaveform(n))}}),i.addEventListener("mouseleave",function(t){e&&(n&&(n.selectionBar=null),d=null,f(e))});var p=null,m=!1,g=null;function v(t,i){n.selectionStart=null,n.selectionEnd=null,n.loopStart=S(t),n.loopEnd=S(i),e.stop(),e.loop(t,i),e.play(e.loopStart),document.getElementById("loopStart").innerHTML=formatTime(t),document.getElementById("loopEnd").innerHTML=formatTime(i),showElement("loopDiv")}function w(){e&&e.looping&&(e.unloop(),n.loopStart=null,n.loopEnd=null,hideElement("loopDiv"))}function y(t){return t*(e.duration/e.waveform.length)}function S(t){return Math.floor(t*(e.waveform.length/e.duration))}function E(t){return Math.floor(function(t,i,e){const n=e.getClientRects()[0];return t-=n.x,i-=n.y,{x:t*(e.width/n.width),y:i*(e.height/n.height)}}(t.clientX,t.clientY,i).x*(e.waveform.length/i.width))}i.addEventListener("mousedown",function(t){e&&(m=!0,p=Date.now(),g=E(t))}),i.addEventListener("mouseup",function(t){if(e)if(m=!1,Date.now()-p<=300){var i=y(E(t));if(!e.isPlaying)return void e.play(i);e.looping&&(i<e.loopStart||i>e.loopEnd)&&w(),e.seek(i),f(e)}else{const t=Math.min(n.selectionStart,n.selectionEnd),i=Math.max(n.selectionStart,n.selectionEnd);v(y(t),y(i))}});var B,b,C=-1;function k(t){n.selectionEnd=S(t.position),b=t.position}document.querySelector("body").onkeydown=function(t){if(e)switch(t.key){case" ":t.preventDefault(),c();break;case"Backspace":t.preventDefault(),w(),n&&n.drawWaveform(n);break;case"ArrowLeft":t.preventDefault(),e.seek(e.position-5);break;case"ArrowRight":t.preventDefault(),e.seek(e.position+5);break;case"ArrowUp":if(t.preventDefault(),x>0){D({target:T.item(x-1)})}break;case"ArrowDown":if(t.preventDefault(),x<T.length-1){D({target:T.item(x+1)})}break;case"l":e.isPlaying&&!e.looping&&(-1===C?(B=e.position,n.selectionStart=S(e.position),C=setInterval(k,20,e)):-1!==C&&(b=e.position,clearInterval(C),C=-1,v(B,b)))}};const T=document.getElementsByClassName("playbackButton");let x=2;function D(t){if(!e)return;if(x>-1&&x<T.length){let t=T.item(x);t.classList.remove("btn-warning"),t.classList.add("btn-secondary")}let i=t.target;i.classList.remove("btn-secondary"),i.classList.add("btn-warning"),e.changePlayback(i.value);for(let t=0;t<T.length;t++){T.item(t).classList.contains("btn-warning")&&(x=t)}}for(let t=0;t<T.length-1;t++)T.item(t).addEventListener("click",D);const M=document.createElement("div"),L=document.createElement("span");M.className="text-center";const _=document.createElement("input");_.type="range",_.max=2,_.min=.25,_.step=.05,_.oninput=function(){L.innerHTML=this.value+"x"},_.onchange=function(){e&&e.changePlayback(this.value)},M.appendChild(L),M.appendChild(document.createElement("br")),M.appendChild(_),$("#custom-speed").popover({placement:"top",html:!0,content:M,trigger:"click"}),$("#custom-speed").on("inserted.bs.popover",function(){_.value=T.item(x).value,L.innerHTML=_.value+"x"}),function(){const t=new XMLHttpRequest;t.open("GET","audio/songturtle.mp3",!0),s="songturtle.mp3",t.onload=function(){a(t.response)},t.responseType="arraybuffer",t.send()}()}();