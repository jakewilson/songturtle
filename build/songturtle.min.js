/*! songturtle 2019-10-17 */

function formatTime(t){return`${Math.floor(t/60)}:${padSeconds(Math.floor(t%60))}`}function padSeconds(t){return t<10?`0${t}`:t}function showElement(t,e){e=e||"block","string"==typeof t&&(t=document.getElementById(t)),t.setAttribute("style",`display:${e}`)}function hideElement(t){"string"==typeof t&&(t=document.getElementById(t)),t.setAttribute("style","display:none")}function Waveform(t,e){this.audioBuffer=t,this.length=e,this.maxData=0,this.rms=function(){this.maxData=-1/0;const t=this.audioBuffer.length,e=Math.floor(t/this.length),i=this.audioBuffer.numberOfChannels,n=[];for(var o=0;o<i;o++)n.push(this.audioBuffer.getChannelData(o));const s=new Float32Array(this.length);for(var a=0,l=0;l<t;l+=e){for(var r=0,h=l;h<l+e;h++)for(o=0;o<i;o++)r+=n[o][h]*n[o][h];const t=Math.sqrt(r/(e*i));s[a++]=t,t>this.maxData&&(this.maxData=t)}return s},this.data=this.rms()}function Song(t,e){this.audioCtx=t,this.isPlaying=!1,this.audioBuffer=e,this.duration=this.audioBuffer.duration,this.intervalId=0,this.playback=1,this.timeStepMs=50,this.position=0,this.waveformLength=200,this.waveform=new Waveform(this.audioBuffer,this.waveformLength),this.looping=!1,this.loopStart=0,this.loopEnd=0,this.startTime=0,this.play=function(t){this.isPlaying||(this._play(t),this.onStartCallback&&this.onStartCallback())},this._play=function(t){void 0===t||null===t?t=this.position:this.position=t,this._createBufferSource(),this.source.start(0,t),this.startTime=this.getCurrentTime(),this.isPlaying=!0,this.lastTimeStep=this.startTime,1!=this.playback?this.intervalId=setTimeout(this.timeStep.bind(this),this.timeStepMs):this.intervalId=setInterval(this.timeStep.bind(this),this.timeStepMs)},this._createBufferSource=function(){this.source=this.audioCtx.createBufferSource(),this.source.buffer=this.audioBuffer,this.looping&&(this.source.loop=!0,this.source.loopStart=this.loopStart,this.source.loopEnd=this.loopEnd),this.source.connect(this.audioCtx.destination)},this.seek=function(t){t<0&&(t=0),this.looping&&(t>this.loopEnd?t=this.loopStart+(t-this.loopEnd):t<this.loopStart&&(t=this.loopStart)),t>this.duration&&(t=this.duration),this.position=t,this.isPlaying&&(this._stop(),this._play())},this.stop=function(){this.isPlaying&&(this._stop(),this.onStopCallback&&this.onStopCallback())},this._stop=function(){clearInterval(this.intervalId),this.position+=this.getDelta()*this.playback,this.source.stop(),this.isPlaying=!1},this.reset=function(){this.position=0,this.unloop()},this.loop=function(t,e){this.looping=!0,this.loopStart=t,this.loopEnd=e},this.unloop=function(){this.looping=!1,this.loopStart=0,this.loopEnd=0,this.isPlaying&&(this._stop(),this._play())},this.lastTimeStep=0,this.timeStep=function(){if(this.isPlaying){if(this.position+=this.getDelta()*this.playback,this.position>this.duration)return this.stop(),void this.reset();if(this.looping){const t=this.loopStart,e=this.loopEnd;this.position>=e&&(this.position=t+(this.position-e))}this.lastTimeStep=this.getCurrentTime(),1!=this.playback&&(this._stop(),this._play())}},this.getDelta=function(){return this.getCurrentTime()-this.lastTimeStep},this.getCurrentTime=function(){return this.audioCtx.currentTime},this.onStartCallback=null,this.onStart=function(t){this.onStartCallback=t},this.onStopCallback=null,this.onStop=function(t){this.onStopCallback=t},this.changePlayback=function(t){this.playback=t,this.isPlaying&&(this.stop(),this.play())}}function Renderer(t,e){this.waveformColor="#000000",this.waveformProgressColor="#ef8a17",this.waveformSelectedColor="#ef2917",this.loopColor="#008148",this.loopProgressColor="#c6c013",this.canvas=t,this.ctx=t.getContext("2d"),this.song=e,this.waveform=e.waveform,this.padding=1,this.scale=(this.canvas.height/2-1)/this.waveform.maxData,this.barWidth=this.canvas.width/this.waveform.length-this.padding,this.selectionBar=null,this.loopStart=null,this.loopEnd=null,this.selectionStart=null,this.selectionEnd=null,this.drawWaveform=function(){if(null==this.canvas||null==this.song||null==this.waveform)return void console.log("canvas, song, or waveform was null; doing nothing.");const t=this.song.position;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const e=Math.ceil(this.waveform.length/this.waveform.audioBuffer.duration*t);if(this.song.looping){if(null!==this.loopStart&&null!==this.loopEnd&&(this._drawBars(this.waveformColor,0,this.loopStart),this._drawBars(this.loopProgressColor,this.loopStart,e),this._drawBars(this.loopColor,e,this.loopEnd),this._drawBars(this.waveformColor,this.loopEnd)),null!==this.selectionStart&&null!==this.selectionEnd){const t=Math.min(this.selectionStart,this.selectionEnd),e=Math.max(this.selectionStart,this.selectionEnd);this._drawBars(this.loopColor,t,e+1)}}else{if(null!==this.selectionBar){const t=Math.min(this.selectionBar,e),i=t===this.selectionBar?e:this.selectionBar;this._drawBars(this.waveformProgressColor,0,t),this._drawBars(this.waveformSelectedColor,t,i),this._drawBars(this.waveformColor,i)}else this._drawBars(this.waveformProgressColor,0,e),this._drawBars(this.waveformColor,e);if(null!==this.selectionStart&&null!==this.selectionEnd){const t=Math.min(this.selectionStart,this.selectionEnd),e=Math.max(this.selectionStart,this.selectionEnd);this._drawBars(this.loopColor,t,e+1)}}window.requestAnimationFrame(this.drawWaveform.bind(this))},this._drawBars=function(t,e,i){void 0!==i&&null!==i||(i=this.waveform.length),this.ctx.fillStyle=t;for(var n=e;n<i;n++)this._drawBar(this.ctx,n*this.barWidth+n*this.padding,this.canvas.height/2,this.barWidth,this.scale*this.waveform.data[n])},this._drawBar=function(t,e,i,n,o){t.fillRect(e+this.padding,i,n,o),t.fillRect(e+this.padding,i,n,-o)}}!function(){const t=new(window.AudioContext||window.webkitAudioContext),e=document.querySelector("canvas");var i=null,n=null,o=null,s="";function a(e){t.decodeAudioData(e,l,r)}function l(o){hideElement("loadingDiv"),showElement("musicDiv"),(i=new Song(t,o,e)).onStart(f),i.onStop(f),(n=new Renderer(e,i)).drawWaveform(),document.getElementById("timeSpan").innerHTML=`0:00/${formatTime(i.duration)}`,document.getElementById("songName").innerHTML=`<strong>${s}</strong>`}function r(t){hideElement("loadingDiv");const e=document.getElementById("errorDiv");showElement(e),e.innerHTML="Error decoding song",console.log("error decoding song")}const h=document.getElementById("fileInput");h.addEventListener("change",d);const c=document.getElementById("drop_zone");function d(){const t=this.files;if(0===t.length)return;hideElement("errorDiv"),i&&(i.stop(),i=null);const e=t[0],n=new FileReader;showElement("loadingDiv"),n.addEventListener("load",t=>{a(t.target.result)}),n.readAsArrayBuffer(e),s=e.name}c.addEventListener("drop",t=>{if(console.log("dropped"),t.preventDefault(),t.dataTransfer.files&&t.dataTransfer.files.length>0){let e=t.dataTransfer.files[0];d.call({files:[e]})}}),c.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="copy"}),$("#drop_zone").click(()=>{$(h).click()});const u=document.getElementById("playButton");function p(){i&&(i.isPlaying?(i.stop(),-1!==T&&(clearInterval(T),T=-1,E(k,i.position))):i.play())}function f(){i&&(i.isPlaying?(u.innerHTML='<i class="fas fa-pause-circle"></i>',o=setInterval(g,200,i)):(u.innerHTML='<i class="fas fa-play-circle"></i>',clearInterval(o)))}u.addEventListener("click",p);var m=null;function g(t){var e=m;null===e&&(e=t.position),e=formatTime(e),document.getElementById("timeSpan").innerHTML=e+"/"+formatTime(t.duration)}e.addEventListener("mousemove",function(t){if(i){var e=C(t);null!==n&&(n.selectionBar=e,m=b(n.selectionBar),g(i)),w&&Date.now()-v>300&&(n.selectionBar=null,n.selectionStart=y,n.selectionEnd=e,i.isPlaying||n.drawWaveform(n))}}),e.addEventListener("mouseleave",function(t){i&&(n&&(n.selectionBar=null),m=null,g(i))});var v=null,w=!1,y=null;function E(t,e){n.selectionStart=null,n.selectionEnd=null,n.loopStart=B(t),n.loopEnd=B(e),i.stop(),i.loop(t,e),i.play(i.loopStart),document.getElementById("loopStart").innerHTML=formatTime(t),document.getElementById("loopEnd").innerHTML=formatTime(e),showElement("loopDiv")}function S(){i&&i.looping&&(i.unloop(),n.loopStart=null,n.loopEnd=null,hideElement("loopDiv"))}function b(t){return t*(i.duration/i.waveform.length)}function B(t){return Math.floor(t*(i.waveform.length/i.duration))}function C(t){return Math.floor(function(t,e,i){const n=i.getClientRects()[0];return t-=n.x,e-=n.y,{x:t*(i.width/n.width),y:e*(i.height/n.height)}}(t.clientX,t.clientY,e).x*(i.waveform.length/e.width))}e.addEventListener("mousedown",function(t){i&&(w=!0,v=Date.now(),y=C(t))}),e.addEventListener("mouseup",function(t){if(i)if(w=!1,Date.now()-v<=300){var e=b(C(t));if(!i.isPlaying)return void i.play(e);i.looping&&(e<i.loopStart||e>i.loopEnd)&&S(),i.seek(e),g(i)}else{const t=Math.min(n.selectionStart,n.selectionEnd),e=Math.max(n.selectionStart,n.selectionEnd);E(b(t),b(e))}});var k,L,T=-1;function D(t){n.selectionEnd=B(t.position),L=t.position}document.querySelector("body").onkeydown=function(t){if(i)switch(t.key){case" ":t.preventDefault(),p();break;case"Backspace":t.preventDefault(),S(),n&&n.drawWaveform(n);break;case"ArrowLeft":t.preventDefault(),i.seek(i.position-5);break;case"ArrowRight":t.preventDefault(),i.seek(i.position+5);break;case"ArrowUp":if(t.preventDefault(),M>0){_({target:x.item(M-1)})}break;case"ArrowDown":if(t.preventDefault(),M<x.length-1){_({target:x.item(M+1)})}break;case"l":i.isPlaying&&!i.looping&&(-1===T?(k=i.position,n.selectionStart=B(i.position),T=setInterval(D,20,i)):-1!==T&&(L=i.position,clearInterval(T),T=-1,E(k,L)))}};const x=document.getElementsByClassName("playbackButton");let M=2;function _(t){if(!i)return;let e=document.getElementById("custom-speed");if(e.classList.contains("btn-warning")&&(e.classList.remove("btn-warning"),e.classList.add("btn-secondary")),M>-1&&M<x.length){let t=x.item(M);t.classList.remove("btn-warning"),t.classList.add("btn-secondary")}let n=t.target;n.classList.remove("btn-secondary"),n.classList.add("btn-warning"),i.changePlayback(n.value);for(let t=0;t<x.length;t++){x.item(t).classList.contains("btn-warning")&&(M=t)}}for(let t=0;t<x.length;t++)x.item(t).addEventListener("click",_);const I=document.createElement("div"),P=document.createElement("span");I.className="text-center";const A=document.createElement("input");A.type="range",A.max=2,A.min=.25,A.step=.05,A.oninput=function(){P.innerHTML=this.value+"x"},A.onchange=function(){i&&i.changePlayback(this.value)},I.appendChild(P),I.appendChild(document.createElement("br")),I.appendChild(A),$("#custom-speed").popover({placement:"top",html:!0,content:I,trigger:"manual"});let H=!0;$("#custom-speed").click(function(){if(H=!1,M>-1&&M<x.length){let t=x.item(M);t.classList.remove("btn-warning"),t.classList.add("btn-secondary")}this.classList.remove("btn-secondary"),this.classList.add("btn-warning"),$(this).popover("toggle")}),$("#custom-speed").on("inserted.bs.popover",function(){A.value=x.item(M).value,P.innerHTML=A.value+"x"}),$("#custom-speed").on("shown.bs.popover",function(){A.value=x.item(M).value,P.innerHTML=A.value+"x",$(".popover").click(()=>{H=!1})}),$("html").click(()=>{H&&$("#custom-speed").popover("hide"),H=!0}),function(){const t=new XMLHttpRequest;t.open("GET","audio/songturtle.mp3",!0),s="songturtle.mp3",t.onload=function(){a(t.response)},t.responseType="arraybuffer",t.send()}()}();